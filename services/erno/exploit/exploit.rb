#!/usr/bin/ruby1.8
require 'socket'

if ARGV.length < 2
	puts "Usage: #{$0} <host> <port> [addr1,addr2,...]"
	exit
end

addrs = ARGV[2..-1]
s = TCPSocket.open(ARGV[0], ARGV[1])

banner = s.gets.chomp
unless banner.index("Welcome to Erno")
	puts "Wrong banner."
	puts "(#{banner.inspect})"
	exit
end

if addrs == []
	s.puts "list"
	res = s.gets.chomp
	if (num = res.split(" ")[0].to_i) == "0"
		puts "Database empty."
		exit
	end
	num.times do
		addrs << s.gets.chomp
	end
end

addrs.each do |addr|
	puts "Cracking #{addr}..."
	f = File.popen("./preimage.rb #{addr.to_i(16).to_s(16)}")
	lines = f.readlines
#	puts lines
	preimg = lines[-1].gsub("preimage bin: ", "").chomp
#	puts preimg.inspect
	s.puts "get " + preimg
	puts "=> " + s.gets
#	s.puts "delete " + preimg
end
